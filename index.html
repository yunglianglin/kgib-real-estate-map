<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>凱基銀行 豪宅實價登錄地圖</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #map {
      position: absolute;
      top: 50px;   /* 頂部預留 topbar 的高度 */
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* 頂部標題列 */
    #topbar {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 50px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #topbar img { height: 35px; margin-right: 10px; }
    #title { font-size: 18px; font-weight: bold; }
    #menuBtn {
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
    }

    /* 側邊篩選欄 */
    #sidebar {
      position: absolute;
      top: 60px;
      right: 10px;
      width: 300px;
      max-height: calc(100% - 70px); /* 限制 sidebar 不超過視窗高度 */
      overflow-y: auto;              /* 內容太多就自己滾動 */
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
    }
    #sidebar h2 {
      font-size: 16px;
      margin-top: 20px;   /* 與上方區塊的距離 */
      margin-bottom: 8px; /* 與下方內容的距離 */
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
      color: #333;
    }
    #sidebar label { display: block; margin-top: 10px; font-weight: bold; }
    #sidebar select, #sidebar input, #sidebar button {
      width: 100%; margin-top: 5px; padding: 6px;
    }

    /* 搜尋結果概要 */
    #summary {
      margin-top: 10px;
      padding: 10px;
      background: #f7f7f7;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div style="display: flex; align-items: center;">
      <img src="logo.png" alt="Logo">
      <div id="title">實價登錄豪宅地圖</div>
    </div>
    <button id="menuBtn">☰</button>
  </div>

  <div id="map"></div>

  <div id="sidebar">
    <h3>六都豪宅定義</h3>
    <div style="font-size:14px; margin-bottom:10px; line-height:1.5; color:#333; padding:8px; background:#f9f9f9; border-radius:8px;">
      台北市：6,000萬元以上<br>
      新北市：4,000萬元以上<br>
      桃園/台中/台南/高雄市：3,000萬元以上
    </div>

    <h3>搜尋條件</h3>
    <label>選擇分行</label>
    <select id="branch">
      <option value="">-- 選擇分行 --</option>
      <optgroup label="基隆">
        <option value="25.1210382,121.7215944">基隆分行</option>
      </optgroup>
      <optgroup label="台北">
        <option value="25.0452783,121.5764971">松山分行</option>
        <option value="25.080456,121.5649951">瑞光分行</option>
        <option value="25.0411712,121.5548868">忠孝分行</option>
        <option value="25.0824539,121.5532775">大直分行</option>
        <option value="25.052963,121.549764">凱基總行</option>
        <option value="25.054978401985,121.54935302295">敦北分行</option>
        <option value="25.0316398,121.5482606">敦南分行</option>
        <option value="25.0516539,121.5436972">城東分行</option>
        <option value="25.05507,121.5330061">松江分行</option>
        <option value="25.0330091,121.5321893">大安分行</option>
        <option value="25.1063286,121.5242319">天母分行</option>
        <option value="25.0510738,121.5222811">中山分行</option>
      </optgroup>
      <optgroup label="新北">
        <option value="24.9840286,121.5387642">新店分行</option>
        <option value="24.9926237653273,121.515572022948">中和分行</option>
        <option value="25.0031971,121.5112113">雙和分行</option>
        <option value="25.0685115,121.4901074">三重分行</option>
        <option value="25.086672,121.4828735">蘆洲分行</option>
        <option value="25.024427,121.4675089">板橋分行</option>
        <option value="24.987861,121.465005">土城分行</option>
        <option value="25.0490286,121.460327">新莊分行</option>
      </optgroup>
      <optgroup label="桃園">
        <option value="24.9909839,121.3082984">桃園分行</option>
        <option value="25.0162507,121.2995099">藝文分行</option>
        <option value="24.957258,121.2240547">中壢分行</option>
      </optgroup>
      <optgroup label="新竹">
        <option value="24.7820167,121.0207938">竹科分行</option>
        <option value="24.8047294,120.9697169">風城分行</option>
        <option value="24.7975194,120.969624">南大分行</option>
        <option value="24.8102237,120.9579519">新竹分行</option>        
      </optgroup>
      <optgroup label="苗栗">
        <option value="24.5680259,120.824352">苗栗分行</option>
      </optgroup>
      <optgroup label="台中">
        <option value="24.2486531,120.7150242">豐原分行</option>
        <option value="24.1105192,120.6897582">大里分行</option>
        <option value="24.1521197,120.6686217">台中分行</option>
        <option value="24.159102,120.6395803">市政分行</option>        
      </optgroup>
      <optgroup label="彰化">
        <option value="23.9583382,120.5664658">員林分行</option>
        <option value="24.0727349,120.5371178">彰化分行</option>
      </optgroup>
      <optgroup label="嘉義">
        <option value="23.4757561099672,120.444502830685">嘉義分行</option>
      </optgroup>
      <optgroup label="台南">
        <option value="22.9657668,120.2941752">歸仁分行</option>
        <option value="22.9991343,120.234277">永康分行</option>
        <option value="23.0070653633494,120.218185938238">北門分行</option>
        <option value="22.9891027,120.210173">東門分行</option>
        <option value="22.9961746,120.2038375">赤崁分行</option>
        <option value="22.9979581,120.1992314">台南分行</option>
        <option value="23.0228904,120.1916418">海東分行</option>
      </optgroup>
      <optgroup label="高雄">
        <option value="22.6281178,120.3708708">鳳山分行</option>
        <option value="22.6683862,120.3172476">北高雄分行</option>
        <option value="22.619533,120.3087674">高雄分行</option>
        <option value="22.6653243,120.3032502">左營分行</option>
        <option value="22.6615699,120.2894257">高美館分行</option>
      </optgroup>
      <optgroup label="屏東">
        <option value="22.6826648,120.4989467">屏東分行</option>
      </optgroup>
      <optgroup label="宜蘭">
        <option value="24.6780719,121.7730545">羅東分行</option>
      </optgroup>
      <optgroup label="花蓮">
        <option value="23.9780816,121.6089386">花蓮分行</option>
      </optgroup>
      <optgroup label="台東">
        <option value="22.754526,121.1534571">台東分行</option>
      </optgroup>
    </select>

    <label>距離 (公里)</label>
    <input type="number" id="distance" placeholder="例如：3" value="3">

    <label>平均交易總價 ≥</label>
    <input type="number" id="minPrice" placeholder="例如：10000000">

    <button id="filterBtn">搜尋</button>

  <h3>搜尋結果概要</h3>
    <div id="summary">
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([25.052963, 121.549764], 14); // 凱基總行中心

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OSM contributors'
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);
    let circle, branchMarker;
    let data = [];

    // 顯示 marker 函式
    function showMarkers(items, color = "red") {
      markersLayer.clearLayers();
      items.forEach(item => {
        let marker = L.marker([item.lat, item.lng], {
          icon: L.icon({
            iconUrl: color === "red" ? "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
                                     : "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
          })
        }).addTo(markersLayer);

        marker.bindPopup(`
          <b>地址：</b>${item.address}<br>
          <b>平均交易總價(近五年)：</b>${item.avg_tot_price.toLocaleString()} 元<br>
          <b>每坪地價(近五年)：</b>${item.avg_price_pin.toLocaleString()} 元/坪<br>
          <b>交易總價區間：</b>${item.min_trx_amt.toLocaleString()} ~ ${item.max_trx_amt.toLocaleString()} 元<br>
          <b>交易次數(近五年)：</b>${item.trx_cnt_5_yrs} 次<br>
          <b>最新交易日期：</b>${item.lst_trx_dte_5_yrs}<br>
        `);
      });
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function filterAndShow(lat, lng, dist, branchName = "選擇的分行") {
      if (circle) map.removeLayer(circle);
      if (branchMarker) map.removeLayer(branchMarker);

      const minPrice = parseFloat(document.getElementById('minPrice').value) || 0;

      // 分行藍色 marker
      branchMarker = L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -28]
        })
      }).addTo(map).bindPopup(branchName).openPopup();

      // 篩選紅色 marker
      let filtered = data.filter(item => 
        getDistance(lat, lng, item.lat, item.lng) <= dist &&
        item.avg_tot_price >= minPrice
      );
      showMarkers(filtered, "red");

      // 畫圓
      circle = L.circle([lat, lng], { radius: dist * 1000, color: "blue", fillOpacity: 0.1 }).addTo(map);

      // 更新概要
      const summaryDiv = document.getElementById('summary');
      if (filtered.length > 0) {
        const avgPrice = Math.round(filtered.reduce((sum, i) => sum + i.avg_tot_price, 0) / filtered.length);
        const maxPrice = Math.max(...filtered.map(i => i.avg_tot_price));
        const minPriceVal = Math.min(...filtered.map(i => i.avg_tot_price));
        summaryDiv.innerHTML = `
          搜尋結果：${filtered.length} 筆<br>
          平均交易總價：${avgPrice.toLocaleString()} 元<br>
          交易總價區間：${minPriceVal.toLocaleString()} ~ ${maxPrice.toLocaleString()} 元
        `;
      } else {
        summaryDiv.innerHTML = "此範圍內無實價登錄資料";
      }

      map.setView([lat, lng], 14);
    }

    // 讀取 markers.json
    fetch('markers.json')
      .then(r => r.json())
      .then(d => {
        data = d;

        // 初始自動篩選總行
        const branchSelect = document.getElementById('branch');
        branchSelect.value = "25.052963,121.549764"; 
        document.getElementById('distance').value = 3;

        filterAndShow(25.052963, 121.549764, 1, "凱基總行");
      });

    // 篩選按鈕事件
    document.getElementById('filterBtn').addEventListener('click', () => {
      const branchVal = document.getElementById('branch').value;
      const dist = parseFloat(document.getElementById('distance').value);
      if (branchVal && dist) {
        const [lat, lng] = branchVal.split(',').map(Number);
        const branchName = document.getElementById('branch')
                                  .selectedOptions[0].textContent; // 取得選單名稱
        filterAndShow(lat, lng, dist, branchName);
      }
    });

    // 側邊欄顯示/隱藏
    document.getElementById('menuBtn').addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      sidebar.style.display = sidebar.style.display === "none" ? "block" : "none";
    });
  </script>
</body>
</html>
