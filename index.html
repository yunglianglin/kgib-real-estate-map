<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>å‡±åŸºéŠ€è¡Œ è±ªå®…å¯¦åƒ¹ç™»éŒ„åœ°åœ–</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: Arial, sans-serif; }
    #map {
      position: absolute;
      top: 50px;   /* é ‚éƒ¨é ç•™ topbar çš„é«˜åº¦ */
      left: 0;
      right: 0;
      bottom: 0;
    }

    /* é ‚éƒ¨æ¨™é¡Œåˆ— */
    #topbar {
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 50px;
      background: white;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 5px 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #topbar img { height: 35px; margin-right: 10px; }
    #title { font-size: 20px; font-weight: bold; }
    #menuBtn {
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
    }

    /* å´é‚Šç¯©é¸æ¬„ */
    #sidebar {
      position: absolute;
      top: 60px;
      right: 10px;
      width: 300px;
      max-height: calc(100% - 70px); /* é™åˆ¶ sidebar ä¸è¶…éè¦–çª—é«˜åº¦ */
      overflow-y: auto;              /* å…§å®¹å¤ªå¤šå°±è‡ªå·±æ»¾å‹• */
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      display: none;
      z-index: 1000;
    }

    #sidebar h2 {
      font-size: 16px;
      margin-top: 12px;   /* èˆ‡ä¸Šæ–¹å€å¡Šçš„è·é›¢ */
      margin-bottom: 3px; /* èˆ‡ä¸‹æ–¹å…§å®¹çš„è·é›¢ */
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
      color: #333;
    }

    /* ç¬¬ä¸€å€‹æ¨™é¡Œï¼ˆè±ªå®…å®šç¾©ï¼‰å»æ‰ margin-top */
    #sidebar h2:first-of-type {
      margin-top: 0;
    }

    #sidebar label { display: block; margin-top: 10px; font-weight: bold; }
    #sidebar select, #sidebar input, #sidebar button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      font-size: 14px;
      box-sizing: border-box;  /* âœ… ç¢ºä¿ padding ä¸æœƒå½±éŸ¿å¯¬åº¦ */
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .section {
      margin-bottom: 12px;
    }
  
    #sidebar button {
      background-color: #A6A6A6;
      color: white;
      border: none;
      cursor: pointer;
    }

    #sidebar button:hover {
      background-color: #0E366B;
    }

    /* æœå°‹çµæœæ¦‚è¦ */
    #summary {
      margin-top: 10px;
      padding: 10px;
      background: #f7f7f7;
      border-radius: 5px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div style="display: flex; align-items: center;">
      <img src="logo.png" alt="Logo">
      <div id="title">å¯¦åƒ¹ç™»éŒ„è±ªå®…åœ°åœ–</div>
    </div>
    <button id="menuBtn">â˜°</button>
  </div>

  <div id="map"></div>

  <div id="sidebar">
    <h3>ğŸ  å…­éƒ½è±ªå®…å®šç¾©</h3>
    <div style="font-size:14px; margin-bottom:10px; line-height:1.5; color:#333; padding:8px; background:#f9f9f9; border-radius:8px;">
      å°åŒ—å¸‚ï¼š6,000è¬å…ƒä»¥ä¸Š<br>
      æ–°åŒ—å¸‚ï¼š4,000è¬å…ƒä»¥ä¸Š<br>
      æ¡ƒåœ’/å°ä¸­/å°å—/é«˜é›„å¸‚ï¼š3,000è¬å…ƒä»¥ä¸Š
    </div>

    <h3>ğŸ” æœå°‹æ¢ä»¶</h3>
    <label>é¸æ“‡åˆ†è¡Œ</label>
    <select id="branch">
      <option value="">-- é¸æ“‡åˆ†è¡Œ --</option>
      <optgroup label="å°åŒ—">
        <option value="25.0452783,121.5764971">æ¾å±±åˆ†è¡Œ</option>
        <option value="25.080456,121.5649951">ç‘å…‰åˆ†è¡Œ</option>
        <option value="25.0411712,121.5548868">å¿ å­åˆ†è¡Œ</option>
        <option value="25.0824539,121.5532775">å¤§ç›´åˆ†è¡Œ</option>
        <option value="25.052963,121.549764">å‡±åŸºç¸½è¡Œ</option>
        <option value="25.054978401985,121.54935302295">æ•¦åŒ—åˆ†è¡Œ</option>
        <option value="25.0316398,121.5482606">æ•¦å—åˆ†è¡Œ</option>
        <option value="25.0516539,121.5436972">åŸæ±åˆ†è¡Œ</option>
        <option value="25.05507,121.5330061">æ¾æ±Ÿåˆ†è¡Œ</option>
        <option value="25.0330091,121.5321893">å¤§å®‰åˆ†è¡Œ</option>
        <option value="25.1063286,121.5242319">å¤©æ¯åˆ†è¡Œ</option>
        <option value="25.0510738,121.5222811">ä¸­å±±åˆ†è¡Œ</option>
      </optgroup>
      <optgroup label="æ–°åŒ—">
        <option value="24.9840286,121.5387642">æ–°åº—åˆ†è¡Œ</option>
        <option value="24.9926237653273,121.515572022948">ä¸­å’Œåˆ†è¡Œ</option>
        <option value="25.0031971,121.5112113">é›™å’Œåˆ†è¡Œ</option>
        <option value="25.0685115,121.4901074">ä¸‰é‡åˆ†è¡Œ</option>
        <option value="25.086672,121.4828735">è˜†æ´²åˆ†è¡Œ</option>
        <option value="25.024427,121.4675089">æ¿æ©‹åˆ†è¡Œ</option>
        <option value="24.987861,121.465005">åœŸåŸåˆ†è¡Œ</option>
        <option value="25.0490286,121.460327">æ–°èŠåˆ†è¡Œ</option>
      </optgroup>
      <optgroup label="æ¡ƒåœ’">
        <option value="24.9909839,121.3082984">æ¡ƒåœ’åˆ†è¡Œ</option>
        <option value="25.0162507,121.2995099">è—æ–‡åˆ†è¡Œ</option>
        <option value="24.957258,121.2240547">ä¸­å£¢åˆ†è¡Œ</option>
      <optgroup label="å°ä¸­">
        <option value="24.2486531,120.7150242">è±åŸåˆ†è¡Œ</option>
        <option value="24.1105192,120.6897582">å¤§é‡Œåˆ†è¡Œ</option>
        <option value="24.1521197,120.6686217">å°ä¸­åˆ†è¡Œ</option>
        <option value="24.159102,120.6395803">å¸‚æ”¿åˆ†è¡Œ</option>        
      <optgroup label="å°å—">
        <option value="22.9657668,120.2941752">æ­¸ä»åˆ†è¡Œ</option>
        <option value="22.9991343,120.234277">æ°¸åº·åˆ†è¡Œ</option>
        <option value="23.0070653633494,120.218185938238">åŒ—é–€åˆ†è¡Œ</option>
        <option value="22.9891027,120.210173">æ±é–€åˆ†è¡Œ</option>
        <option value="22.9961746,120.2038375">èµ¤å´åˆ†è¡Œ</option>
        <option value="22.9979581,120.1992314">å°å—åˆ†è¡Œ</option>
        <option value="23.0228904,120.1916418">æµ·æ±åˆ†è¡Œ</option>
      </optgroup>
      <optgroup label="é«˜é›„">
        <option value="22.6281178,120.3708708">é³³å±±åˆ†è¡Œ</option>
        <option value="22.6683862,120.3172476">åŒ—é«˜é›„åˆ†è¡Œ</option>
        <option value="22.619533,120.3087674">é«˜é›„åˆ†è¡Œ</option>
        <option value="22.6653243,120.3032502">å·¦ç‡Ÿåˆ†è¡Œ</option>
        <option value="22.6615699,120.2894257">é«˜ç¾é¤¨åˆ†è¡Œ</option>
      </optgroup>
    </select>

    <label>è·é›¢ (å…¬é‡Œ)</label>
    <input type="number" id="distance" placeholder="ä¾‹å¦‚ï¼š3" value="3">

    <label>å¹³å‡äº¤æ˜“ç¸½åƒ¹ â‰¥ (è¬å…ƒ)</label>
    <input type="number" id="minPrice" placeholder="ä¾‹å¦‚ï¼š1000">

    <button id="filterBtn">æœå°‹</button>
    <button id="downloadBtn">ä¸‹è¼‰ æœå°‹çµæœ</button>


  <h3>ğŸ“ æœå°‹çµæœæ¦‚è¦</h3>
    <div id="summary">
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([25.052963, 121.549764], 14); // å‡±åŸºç¸½è¡Œä¸­å¿ƒ

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OSM contributors'
    }).addTo(map);

    let markersLayer = L.layerGroup().addTo(map);
    let circle, branchMarker;
    let data = [];
    let filteredData = []; 

    // é¡¯ç¤º marker å‡½å¼
    function showMarkers(items, color = "red") {
      markersLayer.clearLayers();
      items.forEach(item => {
        let marker = L.marker([item.lat, item.lng], {
          icon: L.icon({
            iconUrl: color === "red" ? "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
                                     : "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
          })
        }).addTo(markersLayer);

        marker.bindPopup(`
          <b>åœ°å€ï¼š</b>${item.address}<br>
          <b>å¹³å‡äº¤æ˜“ç¸½åƒ¹(è¿‘äº”å¹´)ï¼š</b>${item.avg_tot_price.toLocaleString()} å…ƒ<br>
          <b>æ¯åªåœ°åƒ¹(è¿‘äº”å¹´)ï¼š</b>${item.avg_price_pin.toLocaleString()} å…ƒ/åª<br>
          <b>äº¤æ˜“ç¸½åƒ¹å€é–“ï¼š</b>${item.min_trx_amt.toLocaleString()} ~ ${item.max_trx_amt.toLocaleString()} å…ƒ<br>
          <b>äº¤æ˜“æ¬¡æ•¸(è¿‘äº”å¹´)ï¼š</b>${item.trx_cnt_5_yrs} æ¬¡<br>
          <b>æœ€æ–°äº¤æ˜“æ—¥æœŸï¼š</b>${item.lst_trx_dte_5_yrs}<br>
        `);
      });
    }

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function filterAndShow(lat, lng, dist, branchName = "é¸æ“‡çš„åˆ†è¡Œ") {
      if (circle) map.removeLayer(circle);
      if (branchMarker) map.removeLayer(branchMarker);

      const minPriceInput = parseFloat(document.getElementById('minPrice').value) || 0;
      const minPrice = minPriceInput * 10000;

      // åˆ†è¡Œè—è‰² marker
      branchMarker = L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          iconSize: [32, 32],
          iconAnchor: [16, 32],
          popupAnchor: [0, -28]
        })
      }).addTo(map).bindPopup(branchName).openPopup();

      // ç¯©é¸ç´…è‰² marker
      let filtered = data.filter(item => 
        getDistance(lat, lng, item.lat, item.lng) <= dist &&
        item.avg_tot_price >= minPrice
      );
      showMarkers(filtered, "red");

       // ç¯©é¸æŒ‰éˆ•äº‹ä»¶ä¸­åŠ å…¥ filteredData = filtered
      filteredData = filtered;

      // ç•«åœ“
      circle = L.circle([lat, lng], { radius: dist * 1000, color: "blue", fillOpacity: 0.1 }).addTo(map);

      // æ›´æ–°æ¦‚è¦
      const summaryDiv = document.getElementById('summary');
      if (filtered.length > 0) {
        const avgPrice = Math.round((filtered.reduce((sum, i) => sum + i.avg_tot_price, 0) / filtered.length)/10000);
        const maxPrice = Math.max(...filtered.map(i => i.avg_tot_price)/10000);
        const minPriceVal = Math.min(...filtered.map(i => i.avg_tot_price)/10000);
        summaryDiv.innerHTML = `
          æœå°‹çµæœï¼š${filtered.length} ç­†<br>
          å¹³å‡äº¤æ˜“ç¸½åƒ¹ï¼š${avgPrice.toLocaleString()} è¬è¬å…ƒ<br>
          äº¤æ˜“ç¸½åƒ¹å€é–“ï¼š${minPriceVal.toLocaleString()} ~ ${maxPrice.toLocaleString()} è¬å…ƒ
        `;
      } else {
        summaryDiv.innerHTML = "æ­¤ç¯„åœå…§ç„¡å¯¦åƒ¹ç™»éŒ„è³‡æ–™";
      }

      map.setView([lat, lng], 14);
    }

    // è®€å– markers.json
    fetch('markers.json')
      .then(r => r.json())
      .then(d => {
        data = d;

        // åˆå§‹è‡ªå‹•ç¯©é¸ç¸½è¡Œ
        const branchSelect = document.getElementById('branch');
        branchSelect.value = "25.052963,121.549764"; 
        document.getElementById('distance').value = 3;

        filterAndShow(25.052963, 121.549764, 1, "å‡±åŸºç¸½è¡Œ");
      });

    // ç¯©é¸æŒ‰éˆ•äº‹ä»¶
    document.getElementById('filterBtn').addEventListener('click', () => {
      const branchVal = document.getElementById('branch').value;
      const dist = parseFloat(document.getElementById('distance').value);
      if (branchVal && dist) {
        const [lat, lng] = branchVal.split(',').map(Number);
        const branchName = document.getElementById('branch')
                                  .selectedOptions[0].textContent; // å–å¾—é¸å–®åç¨±
        filterAndShow(lat, lng, dist, branchName);
      }
    });
     // 3ï¸âƒ£ æ–°å¢ä¸‹è¼‰æŒ‰éˆ•äº‹ä»¶ï¼šå°‡ filteredData è½‰æˆ CSV ä¸¦è§¸ç™¼ä¸‹è¼‰
    document.getElementById('downloadBtn').addEventListener('click', () => {
        if(!filteredData || filteredData.length===0){
          alert("ç›®å‰æ²’æœ‰ç¯©é¸çµæœå¯ä¸‹è¼‰"); 
          return; 
        }
        let csv = "åœ°å€,å¹³å‡äº¤æ˜“ç¸½åƒ¹,æ¯åªåœ°åƒ¹,äº¤æ˜“ç¸½åƒ¹å€é–“,äº¤æ˜“æ¬¡æ•¸,æœ€æ–°äº¤æ˜“æ—¥æœŸ\n";
        filteredData.forEach(item=>{
          csv+=`"${item.address}",${item.avg_tot_price},${item.avg_price_pin},"${item.min_trx_amt}~${item.max_trx_amt}",${item.trx_cnt_5_yrs},${item.lst_trx_dte_5_yrs}\n`;
        });
        let blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        let url = URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;
        a.download = 'ç¯©é¸çµæœ.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    });

    // å´é‚Šæ¬„é¡¯ç¤º/éš±è—
    document.getElementById('menuBtn').addEventListener('click', () => {
      const sidebar = document.getElementById('sidebar');
      sidebar.style.display = sidebar.style.display === "none" ? "block" : "none";
    });
  </script>
</body>
</html>
